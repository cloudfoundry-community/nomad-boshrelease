<%
def discover_external_ip
  networks = spec.networks.marshal_dump
  _, network = networks.find do |_name, network_spec|
    network_spec.default
  end
  if !network
    _, network = networks.first
  end
  if !network
    raise "Could not determine IP via network spec: #{networks}"
  end
  network.ip
end

def client_lan
  properties.nomad.lan.map { |server| server + ":4647" }
end
%>

bind_addr = "<%= discover_external_ip %>"
data_dir = "/var/vcap/store/nomad"
log_level = "<%= properties.nomad.log_level %>"

<% if properties.nomad.server == true %>
server {
  enabled = true
  bootstrap_expect = <%= properties.nomad.lan.size %>
  rejoin_after_leave = true
  retry_join = <%= properties.nomad.lan %>
}
<% else %>
client {
  enabled = true
  servers = <%= client_lan %>
  node_id = "<%= name %>/<%= index %>"
  network_interface = "REPLACE_NETWORK_INTERFACE"
  options {
    docker.endpoint = "unix:///var/vcap/sys/run/docker/docker.sock"
  }

}

<% end %>